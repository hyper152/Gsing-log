#include "oled.h"
#include <string.h>

// 全局I2C句柄
static I2C_HandleTypeDef *oled_hi2c;

// 内部函数声明
static void OLED_WriteCommand(uint8_t cmd);
static void OLED_WriteData(uint8_t data);

// 8x16英文字母点阵库（大写A-Z + 小写a-z，修正取模方向）
const uint8_t ASCII_8x16[52][16] = {
    // 大写字母 A-Z
    [0] = {0x00,0x7C,0x12,0x11,0x11,0x12,0x7C,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x3F,0x00}, // A
    [1] = {0x00,0x7F,0x49,0x49,0x49,0x49,0x7F,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x3F,0x00}, // B
    [2] = {0x00,0x3E,0x41,0x41,0x41,0x41,0x22,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // C
    [3] = {0x00,0x7F,0x41,0x41,0x41,0x41,0x3E,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x3F,0x00}, // D
    [4] = {0x00,0x7F,0x49,0x49,0x49,0x49,0x41,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x3F,0x00}, // E
    [5] = {0x00,0x7F,0x48,0x48,0x48,0x48,0x40,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x00,0x00}, // F
    [6] = {0x00,0x3E,0x41,0x49,0x49,0x49,0x7A,0x00,0x00,0x1F,0x20,0x22,0x22,0x22,0x17,0x00}, // G
    [7] = {0x00,0x44,0x44,0x7C,0x44,0x44,0x44,0x00,0x00,0x40,0x40,0x7F,0x40,0x40,0x40,0x00}, // H
    [8] = {0x00,0x7C,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x1F,0x00}, // I
    [9] = {0x00,0x22,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,0x07,0x08,0x08,0x08,0x48,0x30,0x00}, // J
    [10] = {0x00,0x44,0x48,0x70,0x48,0x44,0x44,0x00,0x00,0x40,0x40,0x7F,0x42,0x41,0x40,0x00}, // K
    [11] = {0x00,0x40,0x40,0x40,0x40,0x40,0x7C,0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x7F,0x00}, // L
    [12] = {0x00,0x41,0x63,0x55,0x49,0x41,0x41,0x00,0x00,0x40,0x78,0x44,0x44,0x44,0x40,0x00}, // M
    [13] = {0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x00,0x00,0x40,0x60,0x50,0x48,0x44,0x40,0x00}, // N
    [14] = {0x00,0x3C,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // O
    [15] = {0x00,0x7C,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x1F,0x00}, // P
    [16] = {0x00,0x3C,0x42,0x42,0x42,0x62,0x7E,0x00,0x00,0x1F,0x20,0x20,0x20,0x28,0x37,0x00}, // Q
    [17] = {0x00,0x7C,0x42,0x42,0x52,0x62,0x4C,0x00,0x00,0x3F,0x40,0x40,0x50,0x60,0x1F,0x00}, // R
    [18] = {0x00,0x22,0x41,0x41,0x41,0x41,0x3E,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // S
    [19] = {0x00,0x7F,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x7F,0x00}, // T
    [20] = {0x00,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x3F,0x00}, // U
    [21] = {0x00,0x42,0x42,0x42,0x24,0x18,0x00,0x00,0x00,0x40,0x40,0x40,0x20,0x20,0x1F,0x00}, // V
    [22] = {0x00,0x41,0x41,0x5A,0x5A,0x4C,0x4C,0x00,0x00,0x40,0x40,0x30,0x30,0x48,0x48,0x00}, // W
    [23] = {0x00,0x42,0x24,0x18,0x18,0x24,0x42,0x00,0x00,0x40,0x20,0x10,0x10,0x20,0x40,0x00}, // X
    [24] = {0x00,0x42,0x24,0x18,0x18,0x18,0x18,0x00,0x00,0x40,0x20,0x10,0x10,0x10,0x1F,0x00}, // Y
    [25] = {0x00,0x7F,0x02,0x04,0x08,0x10,0x7F,0x00,0x00,0x7F,0x02,0x04,0x08,0x10,0x7F,0x00}, // Z

    // 小写字母 a-z
    [26] = {0x00,0x00,0x7C,0x12,0x12,0x12,0x7C,0x00,0x00,0x10,0x3F,0x40,0x40,0x40,0x3F,0x00}, // a
    [27] = {0x00,0x40,0x7C,0x42,0x42,0x42,0x7C,0x00,0x00,0x40,0x7F,0x40,0x40,0x40,0x7F,0x00}, // b
    [28] = {0x00,0x00,0x3C,0x42,0x42,0x42,0x24,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // c
    [29] = {0x00,0x02,0x3E,0x40,0x40,0x40,0x7E,0x00,0x00,0x40,0x7F,0x20,0x20,0x20,0x3F,0x00}, // d
    [30] = {0x00,0x00,0x3C,0x42,0x7E,0x42,0x3C,0x00,0x00,0x1F,0x20,0x3F,0x20,0x20,0x1F,0x00}, // e
    [31] = {0x00,0x1C,0x20,0x7C,0x20,0x20,0x20,0x00,0x00,0x1F,0x20,0x3F,0x20,0x20,0x20,0x00}, // f
    [32] = {0x00,0x00,0x3C,0x42,0x42,0x42,0x7C,0x02,0x00,0x1F,0x20,0x20,0x20,0x30,0x78,0x00}, // g
    [33] = {0x00,0x40,0x7C,0x42,0x42,0x42,0x42,0x00,0x00,0x40,0x7F,0x40,0x40,0x40,0x40,0x00}, // h
    [34] = {0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x10,0x00}, // i
    [35] = {0x00,0x00,0x00,0x7C,0x10,0x10,0x70,0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x78,0x00}, // j
    [36] = {0x00,0x40,0x44,0x48,0x70,0x48,0x44,0x00,0x00,0x40,0x40,0x7F,0x42,0x41,0x40,0x00}, // k
    [37] = {0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x3F,0x10,0x10,0x10,0x10,0x10,0x00}, // l
    [38] = {0x00,0x00,0x44,0x66,0x5A,0x44,0x44,0x00,0x00,0x40,0x78,0x44,0x44,0x44,0x40,0x00}, // m
    [39] = {0x00,0x00,0x7C,0x42,0x42,0x42,0x42,0x00,0x00,0x40,0x7F,0x40,0x40,0x40,0x40,0x00}, // n
    [40] = {0x00,0x00,0x3C,0x42,0x42,0x42,0x3C,0x00,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00}, // o
    [41] = {0x00,0x00,0x7C,0x42,0x42,0x42,0x3C,0x40,0x00,0x3F,0x40,0x40,0x40,0x40,0x1F,0x40}, // p
    [42] = {0x00,0x02,0x3E,0x40,0x40,0x40,0x7E,0x02,0x00,0x1F,0x20,0x20,0x20,0x20,0x3F,0x02}, // q
    [43] = {0x00,0x00,0x7C,0x42,0x40,0x40,0x40,0x00,0x00,0x3F,0x40,0x40,0x40,0x40,0x40,0x00}, // r
    [44] = {0x00,0x00,0x3C,0x40,0x3C,0x02,0x3C,0x00,0x00,0x1F,0x20,0x1F,0x02,0x02,0x1F,0x00}, // s
    [45] = {0x00,0x10,0x10,0x7C,0x10,0x10,0x0E,0x00,0x00,0x10,0x10,0x7F,0x10,0x10,0x1F,0x00}, // t
    [46] = {0x00,0x00,0x42,0x42,0x42,0x42,0x3E,0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x3F,0x00}, // u
    [47] = {0x00,0x00,0x42,0x42,0x24,0x24,0x18,0x00,0x00,0x40,0x40,0x20,0x20,0x20,0x1F,0x00}, // v
    [48] = {0x00,0x00,0x42,0x5A,0x5A,0x24,0x24,0x00,0x00,0x40,0x40,0x30,0x30,0x20,0x20,0x00}, // w
    [49] = {0x00,0x00,0x42,0x24,0x18,0x24,0x42,0x00,0x00,0x40,0x20,0x10,0x20,0x40,0x00,0x00}, // x
    [50] = {0x00,0x00,0x42,0x42,0x42,0x24,0x18,0x18,0x00,0x40,0x40,0x40,0x20,0x20,0x3F,0x00}, // y
    [51] = {0x00,0x00,0x7E,0x04,0x08,0x10,0x7E,0x00,0x00,0x7F,0x02,0x04,0x08,0x10,0x7F,0x00}  // z
};

// 获取字符索引（核心修复：匹配点阵数组）
uint8_t get_index(uint8_t ch) {
  if (ch >= 'A' && ch <= 'Z') return ch - 'A';
  if (ch >= 'a' && ch <= 'z') return ch - 'a' + 26;
  return 0; // 非字母默认显示'A'
}

// 发送命令（增加I2C超时，修复通信丢包）
static void OLED_WriteCommand(uint8_t cmd) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x00, I2C_MEMADD_SIZE_8BIT, &cmd, 1, 500);
}

// 发送数据（增加I2C超时）
static void OLED_WriteData(uint8_t data) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x40, I2C_MEMADD_SIZE_8BIT, &data, 1, 500);
}

// 初始化OLED（适配0.96寸屏，修复寻址模式）
void OLED_Init(I2C_HandleTypeDef *hi2c) {
  oled_hi2c = hi2c;
  HAL_Delay(200);  // 延长上电延时，确保稳定

  OLED_WriteCommand(0xAE);  // 关闭显示
  OLED_WriteCommand(0x20);  // 设置内存寻址模式
  OLED_WriteCommand(0x02);  // 页寻址模式（0.96寸屏最优）

  OLED_WriteCommand(0x00);  // 低列地址
  OLED_WriteCommand(0x10);  // 高列地址
  OLED_WriteCommand(0x40);  // 起始行地址

  OLED_WriteCommand(0xA1);  // 段重映射（适配0.96寸屏）
  OLED_WriteCommand(0xC8);  // COM扫描方向（适配0.96寸屏）
  OLED_WriteCommand(0xA6);  // 正常显示

  OLED_WriteCommand(0xA8);  // 多路复用率
  OLED_WriteCommand(0x3F);  // 64行
  OLED_WriteCommand(0xD3);  // 显示偏移
  OLED_WriteCommand(0x00);

  OLED_WriteCommand(0xD5);  // 时钟分频
  OLED_WriteCommand(0x80);
  OLED_WriteCommand(0xD9);  // 预充电周期
  OLED_WriteCommand(0xF1);

  OLED_WriteCommand(0xDA);  // COM引脚配置
  OLED_WriteCommand(0x12);
  OLED_WriteCommand(0xDB);  // VCOMH电平
  OLED_WriteCommand(0x40);

  OLED_WriteCommand(0x8D);  // 开启电荷泵（必须）
  OLED_WriteCommand(0x14);
  OLED_WriteCommand(0xAF);  // 开启显示

  OLED_Clear(); // 清屏
}

// 清屏
void OLED_Clear(void) {
  uint8_t i, j;
  for (i = 0; i < 8; i++) {
    OLED_WriteCommand(0xB0 + i);
    OLED_WriteCommand(0x00);
    OLED_WriteCommand(0x10);
    for (j = 0; j < 128; j++) {
      OLED_WriteData(0x00);
    }
  }
}

// 显示单个字符（核心修复：边界检查+索引匹配）
void OLED_ShowChar(uint8_t x, uint8_t y, uint8_t ch) {
  uint8_t i;
  // 边界检查（防止越界）
  if (x >= 128 || y >= 7) return;
  uint8_t index = get_index(ch);
  if (index >= 52) return;

  // 设置坐标
  OLED_WriteCommand(0xB0 + y);
  OLED_WriteCommand(0x00 + (x & 0x0F));
  OLED_WriteCommand(0x10 + ((x >> 4) & 0x0F));

  // 写入上8行
  for (i = 0; i < 8; i++) {
    OLED_WriteData(ASCII_8x16[index][i]);
  }

  // 写入下8行（y+1不越界）
  if (y+1 < 8) {
    OLED_WriteCommand(0xB0 + y + 1);
    OLED_WriteCommand(0x00 + (x & 0x0F));
    OLED_WriteCommand(0x10 + ((x >> 4) & 0x0F));
    for (i = 8; i < 16; i++) {
      OLED_WriteData(ASCII_8x16[index][i]);
    }
  }
}

// 显示字符串（修复字符间距）
void OLED_ShowString(uint8_t x, uint8_t y, char *str) {
  uint8_t i = 0;
  while (str[i] != '\0') {
    OLED_ShowChar(x + i * 8, y, str[i]);
    i++;
    // 防止超出屏幕宽度
    if (x + i * 8 >= 128) break;
  }
}
