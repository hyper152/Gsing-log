#include "oled.h"
#include <string.h>
#include "main.h"

// 全局I2C句柄
static I2C_HandleTypeDef *oled_hi2c;

// 屏幕参数定义
#define SCREEN_HEIGHT 64  // OLED屏幕高度
#define CHAR_HEIGHT 16    // 字符高度（8x16点阵）
#define FAZE_UP_LEN 7     // "FaZe up"字符数

// 状态枚举：0-显示hyper，1-滚动显示FaZe up
typedef enum {
    SHOW_HYPER,
    SCROLL_FAZE_UP
} DisplayState;

// 静态全局变量（驱动层内部使用）
static DisplayState current_state = SHOW_HYPER;
static uint32_t hyper_show_time = 0;
static const uint32_t HYPER_DURATION = 2000; // hyper显示时长(ms)
static int16_t scroll_y = SCREEN_HEIGHT;     // FaZe up滚动Y坐标

// 内部函数声明
static void OLED_WriteCommand(uint8_t cmd);
static void OLED_WriteData(uint8_t data);
static uint8_t GetCenterX(uint8_t char_count);
static void OLED_ShowFaZeUp(int16_t y);

// ====================== 点阵数据 ======================
// hyper字符点阵（8x16）
const uint8_t ASCII_8x16[5][16] = {
    // h (索引0)
    [0] = {0x00,0x80,0x00,0x04,0x84,0xFC,0x04,0x04,0x00,0x01,0x01,0x01,0x00,0x01,0x01,0x01},
    // y (索引1)
    [1] = {0x00,0xE8,0x24,0x24,0x24,0x24,0xF8,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00},
    // p (索引2)
    [2] = {0x00,0x70,0x88,0x04,0x04,0x89,0xFF,0x01,0x00,0x00,0x00,0x01,0x01,0x00,0x01,0x01},
    // e (索引3)
    [3] = {0x00,0x80,0x60,0x18,0x1E,0x61,0x81,0x00,0x01,0x01,0x01,0x00,0x00,0x01,0x01,0x01},
    // r (索引4)
    [4] = {0x04,0xFC,0x04,0x00,0x00,0x84,0xFC,0x04,0x00,0x00,0x01,0x01,0x01,0x00,0x0F,0x08}
};

// FaZe up字符点阵（8x16）
const uint8_t FAZE_UP_8x16[7][16] = {
    // F
    {0x00,0x80,0x80,0x00,0xF8,0x38,0x18,0x08,0x18,0xFF,0xFF,0x0F,0x07,0x07,0x06,0x04},
    // a
    {0x00,0x00,0x00,0x00,0x00,0xF8,0x18,0x18,0x18,0xF8,0xF8,0xE0,0x00,0x07,0x04,0x00},
    // Z
    {0xFF,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    // e
    {0x00,0x00,0x00,0x00,0x00,0x98,0x98,0x88,0x98,0xF8,0xF8,0xE0,0x00,0x07,0x07,0x04},
    // 空格
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    // u
    {0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0x98,0xC8,0xF8,0xF8,0x70,0x00,0x07,0x07,0x06},
    // p
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFC,0xFC,0x00,0x00,0x71,0x61,0x21}
};

// ====================== 内部工具函数 ======================
// 字符索引映射（仅适配hyper）
static uint8_t get_index(uint8_t ch) {
  switch(ch) {
    case 'h': return 0;
    case 'y': return 1;
    case 'p': return 2;
    case 'e': return 3;
    case 'r': return 4;
    default: return 0; // 未知字符显示h
  }
}

// 计算居中X坐标
static uint8_t GetCenterX(uint8_t char_count) {
    return (128 - char_count * 8) / 2;
}

// ====================== 底层通信函数 ======================
// 发送OLED命令（I2C超时1秒）
static void OLED_WriteCommand(uint8_t cmd) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x00, I2C_MEMADD_SIZE_8BIT, &cmd, 1, 1000);
}

// 发送OLED数据（I2C超时1秒）
static void OLED_WriteData(uint8_t data) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x40, I2C_MEMADD_SIZE_8BIT, &data, 1, 1000);
}

// ====================== 核心显示函数 ======================
// OLED初始化
void OLED_Init(I2C_HandleTypeDef *hi2c) {
  oled_hi2c = hi2c;
  HAL_Delay(300);  // 延长上电延时

  // OLED初始化指令集
  OLED_WriteCommand(0xAE); // 关闭显示
  OLED_WriteCommand(0x20); // 设置内存寻址模式
  OLED_WriteCommand(0x02); // 页寻址模式
  OLED_WriteCommand(0x00); // 列地址低4位
  OLED_WriteCommand(0x10); // 列地址高4位
  OLED_WriteCommand(0x40); // 设置起始行
  OLED_WriteCommand(0xA0); // 段重映射
  OLED_WriteCommand(0xC0); // COM扫描方向
  OLED_WriteCommand(0xA6); // 正常显示
  OLED_WriteCommand(0xA8); // 多路复用率
  OLED_WriteCommand(0x3F);
  OLED_WriteCommand(0xD3); // 显示偏移
  OLED_WriteCommand(0x00);
  OLED_WriteCommand(0xD5); // 时钟分频
  OLED_WriteCommand(0x80);
  OLED_WriteCommand(0xD9); // 预充电周期
  OLED_WriteCommand(0xF1);
  OLED_WriteCommand(0xDA); // COM引脚配置
  OLED_WriteCommand(0x12);
  OLED_WriteCommand(0xDB); // VCOMH电平
  OLED_WriteCommand(0x40);
  OLED_WriteCommand(0x8D); // 开启电荷泵
  OLED_WriteCommand(0x14);
  OLED_WriteCommand(0xAF); // 开启显示

  OLED_Clear();  // 清屏
  hyper_show_time = HAL_GetTick(); // 初始化hyper显示计时
}

// 清屏函数
void OLED_Clear(void) {
  uint8_t page, col;
  for (page = 0; page < 8; page++) {
    OLED_WriteCommand(0xB0 + page);
    OLED_WriteCommand(0x00);
    OLED_WriteCommand(0x10);
    for (col = 0; col < 128; col++) {
      OLED_WriteData(0x00);
    }
  }
}

// 显示单个字符
void OLED_ShowChar(uint8_t x, uint8_t y, uint8_t ch) {
  uint8_t i;
  if (x >= 128 || y >= 7) return;
  uint8_t idx = get_index(ch);
  if (idx >= 5) return;

  // 写入字符上半部分
  OLED_WriteCommand(0xB0 + y);
  OLED_WriteCommand(0x00 + (x & 0x0F));
  OLED_WriteCommand(0x10 + (x >> 4));
  for (i = 0; i < 8; i++) {
    OLED_WriteData(ASCII_8x16[idx][i]);
  }

  // 写入字符下半部分
  OLED_WriteCommand(0xB0 + y + 1);
  OLED_WriteCommand(0x00 + (x & 0x0F));
  OLED_WriteCommand(0x10 + (x >> 4));
  for (i = 8; i < 16; i++) {
    OLED_WriteData(ASCII_8x16[idx][i]);
  }
}

// 显示字符串
void OLED_ShowString(uint8_t x, uint8_t y, char *str) {
  uint8_t i = 0;
  while (str[i] != '\0') {
    OLED_ShowChar(x + i * 8, y, str[i]);
    i++;
    if (x + i * 8 >= 128) break;
  }
}

// 显示FaZe up（支持任意Y坐标滚动）
static void OLED_ShowFaZeUp(int16_t y) {
    if (y + CHAR_HEIGHT < 0) return;  // 完全超出顶部
    if (y >= SCREEN_HEIGHT) return;   // 完全超出底部

    uint8_t x = GetCenterX(FAZE_UP_LEN);
    for (uint8_t i = 0; i < FAZE_UP_LEN; i++) {
        uint8_t page_offset = y / 8;
        uint8_t start_page = (page_offset < 0) ? 0 : page_offset;

        // 处理字符上半部分（0-7行）
        if (start_page < 8) {
            OLED_WriteCommand(0xB0 + start_page);
            OLED_WriteCommand(0x00 + (x & 0x0F));
            OLED_WriteCommand(0x10 + (x >> 4));

            for (uint8_t row = 0; row < 8; row++) {
                if (row + y < 0 || row + y >= SCREEN_HEIGHT) {
                    OLED_WriteData(0x00);
                } else {
                    OLED_WriteData(FAZE_UP_8x16[i][row]);
                }
            }
        }

        // 处理字符下半部分（8-15行）
        if (start_page + 1 < 8) {
            OLED_WriteCommand(0xB0 + start_page + 1);
            OLED_WriteCommand(0x00 + (x & 0x0F));
            OLED_WriteCommand(0x10 + (x >> 4));

            for (uint8_t row = 8; row < 16; row++) {
                if (row + y < 0 || row + y >= SCREEN_HEIGHT) {
                    OLED_WriteData(0x00);
                } else {
                    OLED_WriteData(FAZE_UP_8x16[i][row]);
                }
            }
        }
        x += 8;  // 下一个字符偏移
    }
}

// 主显示逻辑（对外暴露的核心函数）
void OLED_ShowMainLogic(void) {
    if (current_state == SHOW_HYPER) {
        // 居中显示hyper
        OLED_Clear();
        OLED_ShowString(GetCenterX(5), 3, "hyper");

        // 检查是否达到显示时长
        if (HAL_GetTick() - hyper_show_time >= HYPER_DURATION) {
            current_state = SCROLL_FAZE_UP;
            scroll_y = SCREEN_HEIGHT;  // 重置滚动起始位置
        }
        HAL_Delay(100);
    } else {
        // 滚动显示FaZe up
        OLED_Clear();
        OLED_ShowFaZeUp(scroll_y);
        scroll_y--;  // 向上移动1像素

        // 完全滚动出屏幕顶部后重置位置
        if (scroll_y < -CHAR_HEIGHT) {
            scroll_y = SCREEN_HEIGHT;
        }
        HAL_Delay(50);  // 滚动速度控制
    }
}
