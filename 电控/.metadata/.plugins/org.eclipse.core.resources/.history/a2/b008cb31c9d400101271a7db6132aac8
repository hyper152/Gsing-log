#include "oled.h"
#include <string.h>

// 全局I2C句柄
static I2C_HandleTypeDef *oled_hi2c;

// 内部函数声明
static void OLED_WriteCommand(uint8_t cmd);
static void OLED_WriteData(uint8_t data);

// 8x16英文字母点阵库（大写A-Z + 小写a-z）
const uint8_t ASCII_8x16[52][16] = {
    // 大写字母 A-Z
    [0] = {0x00,0x00,0x1C,0x22,0x7E,0x22,0x22,0x22,0x22,0x3E,0x22,0x00,0x00,0x00,0x00,0x00}, // A
    [1] = {0x00,0x00,0x7C,0x42,0x42,0x7C,0x42,0x42,0x42,0x7C,0x40,0x00,0x00,0x00,0x00,0x00}, // B
    [2] = {0x00,0x00,0x3C,0x42,0x40,0x40,0x40,0x40,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // C
    [3] = {0x00,0x00,0x7C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7C,0x00,0x00,0x00,0x00,0x00}, // D
    [4] = {0x00,0x00,0x7E,0x40,0x40,0x7C,0x40,0x40,0x40,0x40,0x7E,0x00,0x00,0x00,0x00,0x00}, // E
    [5] = {0x00,0x00,0x7E,0x40,0x40,0x7C,0x40,0x40,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x00}, // F
    [6] = {0x00,0x00,0x3C,0x42,0x40,0x40,0x40,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // G
    [7] = {0x00,0x00,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00}, // H
    [8] = {0x00,0x00,0x7E,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7E,0x00,0x00,0x00,0x00,0x00}, // I
    [9] = {0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x48,0x30,0x00,0x00,0x00,0x00,0x00}, // J
    [10] = {0x00,0x00,0x44,0x48,0x50,0x70,0x50,0x48,0x44,0x42,0x42,0x00,0x00,0x00,0x00,0x00}, // K
    [11] = {0x00,0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7E,0x00,0x00,0x00,0x00,0x00}, // L
    [12] = {0x00,0x00,0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81,0x81,0x00,0x00,0x00,0x00,0x00}, // M
    [13] = {0x00,0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00}, // N
    [14] = {0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // O
    [15] = {0x00,0x00,0x7C,0x42,0x42,0x42,0x7C,0x40,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x00}, // P
    [16] = {0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x62,0x42,0x3C,0x02,0x00,0x00,0x00,0x00}, // Q
    [17] = {0x00,0x00,0x7C,0x42,0x42,0x42,0x7C,0x50,0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00}, // R
    [18] = {0x00,0x00,0x3E,0x40,0x40,0x40,0x3C,0x02,0x02,0x02,0x3C,0x00,0x00,0x00,0x00,0x00}, // S
    [19] = {0x00,0x00,0x7F,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x00,0x00,0x00}, // T
    [20] = {0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // U
    [21] = {0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x24,0x18,0x00,0x00,0x00,0x00,0x00}, // V
    [22] = {0x00,0x00,0x81,0x81,0x81,0x81,0x5A,0x24,0x24,0x24,0x24,0x00,0x00,0x00,0x00,0x00}, // W
    [23] = {0x00,0x00,0x42,0x24,0x18,0x18,0x0C,0x0C,0x18,0x18,0x24,0x42,0x00,0x00,0x00,0x00}, // X
    [24] = {0x00,0x00,0x42,0x24,0x18,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x00,0x00,0x00,0x00,0x00}, // Y
    [25] = {0x00,0x00,0x7E,0x02,0x04,0x08,0x10,0x20,0x40,0x40,0x7E,0x00,0x00,0x00,0x00,0x00}, // Z

    // 小写字母 a-z
    [26] = {0x00,0x00,0x00,0x00,0x1C,0x22,0x22,0x22,0x22,0x22,0x3E,0x00,0x00,0x00,0x00,0x00}, // a
    [27] = {0x00,0x00,0x40,0x40,0x40,0x7C,0x42,0x42,0x42,0x42,0x7C,0x00,0x00,0x00,0x00,0x00}, // b
    [28] = {0x00,0x00,0x00,0x00,0x3C,0x42,0x40,0x40,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // c
    [29] = {0x00,0x00,0x02,0x02,0x02,0x3E,0x42,0x42,0x42,0x42,0x3E,0x00,0x00,0x00,0x00,0x00}, // d
    [30] = {0x00,0x00,0x00,0x00,0x3C,0x42,0x7E,0x40,0x40,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // e
    [31] = {0x00,0x00,0x1C,0x22,0x20,0x7C,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00}, // f
    [32] = {0x00,0x00,0x00,0x00,0x3C,0x42,0x40,0x40,0x42,0x42,0x3C,0x02,0x02,0x3C,0x00,0x00}, // g
    [33] = {0x00,0x00,0x40,0x40,0x40,0x7C,0x42,0x42,0x42,0x42,0x42,0x00,0x00,0x00,0x00,0x00}, // h
    [34] = {0x00,0x00,0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x00,0x00,0x00}, // i
    [35] = {0x00,0x00,0x00,0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x70,0x00,0x00}, // j
    [36] = {0x00,0x00,0x40,0x40,0x44,0x48,0x50,0x70,0x50,0x48,0x44,0x00,0x00,0x00,0x00,0x00}, // k
    [37] = {0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x00,0x00,0x00,0x00,0x00}, // l
    [38] = {0x00,0x00,0x00,0x00,0x42,0x66,0x5A,0x52,0x52,0x42,0x42,0x00,0x00,0x00,0x00,0x00}, // m
    [39] = {0x00,0x00,0x00,0x00,0x42,0x62,0x52,0x52,0x4A,0x46,0x42,0x00,0x00,0x00,0x00,0x00}, // n
    [40] = {0x00,0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,0x00,0x00,0x00}, // o
    [41] = {0x00,0x00,0x00,0x00,0x42,0x62,0x52,0x52,0x52,0x52,0x3C,0x40,0x40,0x40,0x00,0x00}, // p
    [42] = {0x00,0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x62,0x42,0x02,0x02,0x00,0x00,0x00}, // q
    [43] = {0x00,0x00,0x00,0x00,0x42,0x62,0x50,0x50,0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00}, // r
    [44] = {0x00,0x00,0x00,0x00,0x3C,0x40,0x40,0x3C,0x02,0x02,0x3C,0x00,0x00,0x00,0x00,0x00}, // s
    [45] = {0x00,0x00,0x00,0x10,0x10,0x7C,0x10,0x10,0x10,0x10,0x0E,0x00,0x00,0x00,0x00,0x00}, // t
    [46] = {0x00,0x00,0x00,0x00,0x42,0x42,0x42,0x42,0x42,0x3E,0x02,0x00,0x00,0x00,0x00,0x00}, // u
    [47] = {0x00,0x00,0x00,0x00,0x42,0x42,0x42,0x24,0x24,0x24,0x18,0x00,0x00,0x00,0x00,0x00}, // v
    [48] = {0x00,0x00,0x00,0x00,0x42,0x42,0x5A,0x5A,0x24,0x24,0x24,0x00,0x00,0x00,0x00,0x00}, // w
    [49] = {0x00,0x00,0x00,0x00,0x42,0x24,0x18,0x18,0x24,0x24,0x42,0x00,0x00,0x00,0x00,0x00}, // x
    [50] = {0x00,0x00,0x00,0x00,0x42,0x42,0x42,0x24,0x24,0x24,0x18,0x18,0x00,0x18,0x00,0x00}, // y
    [51] = {0x00,0x00,0x00,0x00,0x7E,0x04,0x08,0x10,0x20,0x40,0x7E,0x00,0x00,0x00,0x00,0x00}  // z
};

uint8_t get_index(uint8_t ch) {
  if (ch >= 'A' && ch <= 'Z') return ch - 'A';
  if (ch >= 'a' && ch <= 'z') return ch - 'a' + 26;
  // 新增常用字符处理（如空格）
  if (ch == ' ') return 52; // 假设后续添加空格点阵
  return 0; // 其他字符默认显示'A'
}
// 发送命令
static void OLED_WriteCommand(uint8_t cmd) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x00, I2C_MEMADD_SIZE_8BIT, &cmd, 1, 100);
}

// 发送数据
static void OLED_WriteData(uint8_t data) {
  HAL_I2C_Mem_Write(oled_hi2c, OLED_ADDR, 0x40, I2C_MEMADD_SIZE_8BIT, &data, 1, 100);
}

// 初始化OLED
void OLED_Init(I2C_HandleTypeDef *hi2c) {
  oled_hi2c = hi2c;
  HAL_Delay(100);  // 上电延时，确保稳定

  OLED_WriteCommand(0xAE);  // 关闭显示

  // 0.96英寸屏需明确设置内存寻址模式（关键）
  OLED_WriteCommand(0x20);  // 设置内存寻址模式
  OLED_WriteCommand(0x00);  // 水平寻址模式（适合字符显示）

  OLED_WriteCommand(0x00);  // 低列地址
  OLED_WriteCommand(0x10);  // 高列地址
  OLED_WriteCommand(0x40);  // 起始行地址（0x40=第0行）

  OLED_WriteCommand(0xB0);  // 页地址（0xB0~0xB7对应8页，64行）
  OLED_WriteCommand(0xA1);  // 段重映射（0.96英寸屏通常需要左右反置）
  OLED_WriteCommand(0xA6);  // 正常显示（非反显）

  OLED_WriteCommand(0xA8);  // 设置多路复用率
  OLED_WriteCommand(0x3F);  // 64行（0.96英寸屏对应值）

  OLED_WriteCommand(0xC8);  //  COM输出扫描方向（上下反置，根据屏幕调整）
  OLED_WriteCommand(0xD3);  // 显示偏移
  OLED_WriteCommand(0x00);  // 无偏移

  OLED_WriteCommand(0xD5);  // 时钟分频因子
  OLED_WriteCommand(0x80);  // 默认值（100Hz）
  OLED_WriteCommand(0xD9);  // 预充电周期
  OLED_WriteCommand(0xF1);  // 增强对比度（适合3.3V供电）

  OLED_WriteCommand(0xDA);  // COM引脚硬件配置
  OLED_WriteCommand(0x12);  // 128×64屏标准配置

  OLED_WriteCommand(0xDB);  // VCOMH输出电平
  OLED_WriteCommand(0x40);  // 0.77×VCC（标准值）

  OLED_WriteCommand(0x8D);  // 电荷泵设置
  OLED_WriteCommand(0x14);  // 开启电荷泵（0.96英寸屏必须开启，否则不亮）

  OLED_WriteCommand(0xAF);  // 开启显示
  OLED_Clear();
}
// 清屏
void OLED_Clear(void) {
  uint8_t i, j;
  for (i = 0; i < 8; i++) {
    OLED_WriteCommand(0xB0 + i); // 设置页地址
    OLED_WriteCommand(0x00);     // 设置列低地址
    OLED_WriteCommand(0x10);     // 设置列高地址
    for (j = 0; j < 128; j++) {
      OLED_WriteData(0x00);      // 写入0，清除数据
    }
  }
}

// 显示单个字符
void OLED_ShowChar(uint8_t x, uint8_t y, uint8_t ch) {
  uint8_t i;
  // 计算字符在点阵数组中的索引（减去空格的ASCII码32）
  uint8_t index = get_index(ch);  // 使用已定义的get_index函数
  // 检查索引是否超出范围（防止越界）
  if (index >= sizeof(ASCII_8x16)/sizeof(ASCII_8x16[0])) {
    return; // 无效字符不显示
  }

  OLED_WriteCommand(0xB0 + y);                  // 设置页地址
  OLED_WriteCommand(0x00 + (x & 0x0F));         // 设置列低地址
  OLED_WriteCommand(0x10 + ((x >> 4) & 0x0F));  // 设置列高地址

  for (i = 0; i < 8; i++) {
    OLED_WriteData(ASCII_8x16[index][i]);       // 上半部分（使用计算后的索引）
  }

  OLED_WriteCommand(0xB0 + y + 1);              // 下一页
  OLED_WriteCommand(0x00 + (x & 0x0F));
  OLED_WriteCommand(0x10 + ((x >> 4) & 0x0F));

  for (i = 8; i < 16; i++) {
    OLED_WriteData(ASCII_8x16[index][i]);       // 下半部分
  }
}

// 显示字符串
void OLED_ShowString(uint8_t x, uint8_t y, char *str) {
  uint8_t i = 0;
  while (str[i] != '\0') {
    OLED_ShowChar(x + i * 8, y, str[i]);
    i++;
  }
}
